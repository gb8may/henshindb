<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Henshin Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body class="bg-slate-900 text-slate-100">
  <div class="h-full flex flex-col max-w-md mx-auto bg-slate-900">

    <header class="h-14 flex items-center justify-center border-b border-slate-800 bg-slate-950/70">
      <h1 class="text-lg font-semibold tracking-wide">Henshin Database</h1>
    </header>

    <nav class="grid grid-cols-2 gap-2 border-b border-slate-800 px-3 py-2 bg-slate-900">
      <button id="tab-characters"
              class="py-2 rounded-full text-sm font-medium bg-slate-100 text-slate-900">
        Personagens
      </button>
      <button id="tab-glossary"
              class="py-2 rounded-full text-sm font-medium bg-slate-800 text-slate-200">
        Glossário
      </button>
      <button id="tab-collectibles"
              class="py-2 rounded-full text-sm font-medium bg-slate-800 text-slate-200">
        Colecionáveis
      </button>
      <button id="tab-publications"
              class="py-2 rounded-full text-sm font-medium bg-slate-800 text-slate-200">
        Publicações
      </button>
    </nav>

    <div class="px-3 py-2 bg-slate-900">
      <div class="flex items-center gap-2 bg-slate-800 rounded-full px-3 py-2 w-full">
        <input
          id="search-input"
          type="text"
          placeholder="Buscar por nome, termo ou linha…"
          class="bg-transparent outline-none w-full text-sm text-slate-100 placeholder:text-slate-500"
        />
      </div>
    </div>

    <main class="flex-1 overflow-y-auto px-2 pb-16">
      <ul id="list-characters" class="space-y-1 hidden"></ul>
      <ul id="list-glossary" class="space-y-1 hidden"></ul>
      <ul id="list-collectibles" class="space-y-1 hidden"></ul>
      <ul id="list-publications" class="space-y-1 hidden"></ul>

      <div id="empty-state" class="text-center text-slate-500 text-sm mt-6">
        Digite algo na busca para começar.
      </div>
    </main>

    <div
      id="detail-overlay"
      class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden p-4"
    >
      <div class="bg-slate-900 w-full max-w-md max-h-[85vh] overflow-y-auto rounded-2xl shadow-2xl border border-slate-800">
        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800">
          <button id="detail-close" class="text-sm text-slate-300 hover:text-white">Fechar</button>
          <h2 id="detail-title" class="text-sm font-medium text-slate-200 truncate max-w-[60%] text-center"></h2>
          <span class="w-10"></span>
        </div>
        <div id="detail-body" class="px-4 py-4 text-sm text-slate-100 space-y-4"></div>
      </div>
    </div>

    <footer class="h-10 flex items-center justify-center text-[11px] text-slate-500">
      v0.1 · Henshin DB · Author: Mayara Gouveia
    </footer>
  </div>

  <script>
    const SUPABASE_URL = "https://grvmisyiyxzlqfqgponm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdydm1pc3lpeXh6bHFmcWdwb25tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTgwNTgsImV4cCI6MjA4MDg3NDA1OH0.VPzEEvayTYxVZ7D56h7pWFCVDykciO7OCmGrmD1J0XE";

    let currentTab = "characters";
    let charactersData = [];
    let glossaryData = [];
    let collectiblesData = [];
    let publicationsData = [];
    let currentSearch = "";

    const tabCharactersBtn = document.getElementById("tab-characters");
    const tabGlossaryBtn = document.getElementById("tab-glossary");
    const tabCollectiblesBtn = document.getElementById("tab-collectibles");
    const tabPublicationsBtn = document.getElementById("tab-publications");
    const searchInput = document.getElementById("search-input");

    const listCharactersEl = document.getElementById("list-characters");
    const listGlossaryEl = document.getElementById("list-glossary");
    const listCollectiblesEl = document.getElementById("list-collectibles");
    const listPublicationsEl = document.getElementById("list-publications");
    const emptyStateEl = document.getElementById("empty-state");

    const detailOverlay = document.getElementById("detail-overlay");
    const detailBody = document.getElementById("detail-body");
    const detailTitle = document.getElementById("detail-title");
    const detailClose = document.getElementById("detail-close");

    async function fetchCharacters(search = "") {
      let url = `${SUPABASE_URL}/rest/v1/characters?select=*&order=year.asc`;
      if (search.trim() !== "") {
        const encoded = encodeURIComponent("%" + search + "%");
        url += `&or=(name_pt.ilike.${encoded},name_en.ilike.${encoded},franchise.ilike.${encoded})`;
      }
      const res = await fetch(url, {
        headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
      });
      charactersData = await res.json();
      return charactersData;
    }

    async function fetchGlossary(search = "") {
      let url = `${SUPABASE_URL}/rest/v1/glossary?select=*&order=jp.asc`;
      if (search.trim() !== "") {
        const encoded = encodeURIComponent(search);
        url += `&or=(jp.ilike.%${encoded}%,romaji.ilike.%${encoded}%,pt.ilike.%${encoded}%)`;
      }
      const res = await fetch(url, {
        headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
      });
      glossaryData = await res.json();
      return glossaryData;
    }

    async function fetchCollectibles(search = "") {
      let url = `${SUPABASE_URL}/rest/v1/collectibles?select=*&order=year.asc`;
      if (search.trim() !== "") {
        const encoded = encodeURIComponent("%" + search + "%");
        url += `&or=(name_pt.ilike.${encoded},name_en.ilike.${encoded},line.ilike.${encoded},item_type.ilike.${encoded})`;
      }
      const res = await fetch(url, {
        headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
      });
      collectiblesData = await res.json();
      return collectiblesData;
    }

    async function fetchPublications(search = "") {
      let url = `${SUPABASE_URL}/rest/v1/publications?select=*&order=year.asc`;
      if (search.trim() !== "") {
        const encoded = encodeURIComponent("%" + search + "%");
        url += `&or=(title_pt.ilike.${encoded},title_en.ilike.${encoded},publisher.ilike.${encoded})`;
      }
      const res = await fetch(url, {
        headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
      });
      publicationsData = await res.json();
      return publicationsData;
    }

    async function fetchCollectiblesForCharacter(characterId) {
      if (!characterId) return [];
      const url =
        `${SUPABASE_URL}/rest/v1/collectibles` +
        `?select=*,character_collectibles!inner(character_id)` +
        `&character_collectibles.character_id=eq.${characterId}`;
      const res = await fetch(url, {
        headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
      });
      return await res.json();
    }

    async function fetchPublicationsForCharacter(characterId) {
      if (!characterId) return [];
      const url =
        `${SUPABASE_URL}/rest/v1/publications` +
        `?select=*,character_publications!inner(character_id)` +
        `&character_publications.character_id=eq.${characterId}`;
      const res = await fetch(url, {
        headers: { apikey: SUPABASE_ANON_KEY, Authorization: "Bearer " + SUPABASE_ANON_KEY }
      });
      return await res.json();
    }

    function hideAllLists() {
      listCharactersEl.classList.add("hidden");
      listGlossaryEl.classList.add("hidden");
      listCollectiblesEl.classList.add("hidden");
      listPublicationsEl.classList.add("hidden");
    }

    function clearAllLists() {
      listCharactersEl.innerHTML = "";
      listGlossaryEl.innerHTML = "";
      listCollectiblesEl.innerHTML = "";
      listPublicationsEl.innerHTML = "";
    }

    function showEmptySearchMessage() {
      clearAllLists();
      hideAllLists();
      emptyStateEl.textContent = "Digite algo na busca para começar.";
      emptyStateEl.classList.remove("hidden");
    }

    function renderCharactersList() {
      listCharactersEl.innerHTML = "";
      if (!charactersData.length) {
        hideAllLists();
        emptyStateEl.textContent = "Nenhum personagem encontrado.";
        emptyStateEl.classList.remove("hidden");
        return;
      }
      emptyStateEl.classList.add("hidden");
      hideAllLists();

      charactersData.forEach(c => {
        const name = c.name_pt || c.name_en || "";
        const li = document.createElement("li");
        li.className =
          "px-3 py-3 border-b border-slate-800 hover:bg-slate-800/60 cursor-pointer";
        li.innerHTML = `
          <div class="flex items-center gap-3 w-full">
            ${
              c.image_url
                ? `<img src="${c.image_url}" class="w-12 h-12 flex-shrink-0 rounded-full object-cover border border-slate-700" />`
                : `<div class="w-12 h-12 flex-shrink-0 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-xs text-slate-400">?</div>`
            }
            <div class="flex flex-col min-w-0">
              <span class="text-sm font-semibold truncate">${name}</span>
              <span class="text-[11px] text-slate-400 uppercase tracking-wide truncate">
                ${(c.franchise || "")}${c.year ? " · " + c.year : ""}
              </span>
            </div>
          </div>`;
        li.onclick = () => showCharacterDetail(c);
        listCharactersEl.appendChild(li);
      });

      listCharactersEl.classList.remove("hidden");
    }

    function renderGlossaryList() {
      listGlossaryEl.innerHTML = "";
      if (!glossaryData.length) {
        hideAllLists();
        emptyStateEl.textContent = "Nenhum termo encontrado.";
        emptyStateEl.classList.remove("hidden");
        return;
      }
      emptyStateEl.classList.add("hidden");
      hideAllLists();

      glossaryData.forEach(g => {
        const li = document.createElement("li");
        li.className =
          "px-3 py-3 border-b border-slate-800 hover:bg-slate-800/60 cursor-pointer";
        li.innerHTML = `
          <div class="flex flex-col min-w-0">
            <span class="text-sm font-semibold truncate">${g.jp}</span>
            ${g.romaji ? `<span class="text-[11px] text-slate-300 truncate">${g.romaji}</span>` : ""}
            ${g.pt ? `<span class="text-xs text-slate-400 mt-1 line-clamp-2">${g.pt}</span>` : ""}
          </div>`;
        li.onclick = () => showGlossaryDetail(g);
        listGlossaryEl.appendChild(li);
      });

      listGlossaryEl.classList.remove("hidden");
    }

    function renderCollectiblesList() {
      listCollectiblesEl.innerHTML = "";
      if (!collectiblesData.length) {
        hideAllLists();
        emptyStateEl.textContent = "Nenhum colecionável encontrado.";
        emptyStateEl.classList.remove("hidden");
        return;
      }
      emptyStateEl.classList.add("hidden");
      hideAllLists();

      collectiblesData.forEach(col => {
        const name = col.name_pt || col.name_en || "";
        const li = document.createElement("li");
        li.className =
          "px-3 py-3 border-b border-slate-800 hover:bg-slate-800/60 cursor-pointer";
        li.innerHTML = `
          <div class="flex flex-col min-w-0">
            <span class="text-sm font-semibold truncate">${name}</span>
            <span class="text-[11px] text-slate-400 uppercase tracking-wide truncate">
              ${(col.line || "")}${col.item_type ? " · " + col.item_type : ""}${col.year ? " · " + col.year : ""}
            </span>
            ${col.manufacturer ? `<span class="text-[11px] text-slate-500 truncate">${col.manufacturer}</span>` : ""}
          </div>`;
        listCollectiblesEl.appendChild(li);
      });

      listCollectiblesEl.classList.remove("hidden");
    }

    function renderPublicationsList() {
      listPublicationsEl.innerHTML = "";
      if (!publicationsData.length) {
        hideAllLists();
        emptyStateEl.textContent = "Nenhuma publicação encontrada.";
        emptyStateEl.classList.remove("hidden");
        return;
      }
      emptyStateEl.classList.add("hidden");
      hideAllLists();

      publicationsData.forEach(pub => {
        const title = pub.title_pt || pub.title_en || "";
        const li = document.createElement("li");
        li.className =
          "px-3 py-3 border-b border-slate-800 hover:bg-slate-800/60 cursor-pointer";
        li.innerHTML = `
          <div class="flex flex-col min-w-0">
            <span class="text-sm font-semibold truncate">${title}</span>
            <span class="text-[11px] text-slate-400 uppercase tracking-wide truncate">
              ${(pub.pub_type || "")}${pub.year ? " · " + pub.year : ""}
            </span>
            ${pub.publisher ? `<span class="text-[11px] text-slate-500 truncate">${pub.publisher}</span>` : ""}
          </div>`;
        listPublicationsEl.appendChild(li);
      });

      listPublicationsEl.classList.remove("hidden");
    }

    async function showCharacterDetail(c) {
      detailTitle.textContent = c.name_pt || c.name_en || "";
      detailBody.innerHTML = "";

      const parts = [];

      if (c.image_url) {
        parts.push(`
          <img src="${c.image_url}"
               class="w-full h-48 max-h-56 object-cover rounded-xl border border-slate-800" />
        `);
      }

      if (c.name_jp) {
        parts.push(`<div class="text-sm text-slate-200 mt-2">${c.name_jp}</div>`);
      }

      parts.push(`
        <div class="text-[11px] text-slate-400 uppercase tracking-wide mt-1">
          ${(c.franchise || "")}${c.year ? " · " + c.year : ""}
        </div>
      `);

      if (c.description) {
        parts.push(`
          <section class="mt-4">
            <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Descrição</h3>
            <p class="text-sm mt-1 leading-relaxed">${c.description}</p>
          </section>
        `);
      }

      if (c.powers) {
        parts.push(`
          <section class="mt-4">
            <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Poderes</h3>
            <p class="text-sm mt-1 leading-relaxed">${c.powers}</p>
          </section>
        `);
      }

      if (c.equipment) {
        parts.push(`
          <section class="mt-4">
            <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Equipamentos</h3>
            <p class="text-sm mt-1 leading-relaxed">${c.equipment}</p>
          </section>
        `);
      }

      detailBody.innerHTML = parts.join("");
      detailOverlay.classList.remove("hidden");

      try {
        const [collectibles, publications] = await Promise.all([
          fetchCollectiblesForCharacter(c.id),
          fetchPublicationsForCharacter(c.id)
        ]);

        let extrasHtml = "";

        if (collectibles && collectibles.length) {
          const items = collectibles
            .map(col => {
              const line = col.line || "";
              const type = col.item_type || "";
              const year = col.year || "";
              const manufacturer = col.manufacturer || "";
              return `
                <li class="flex flex-col gap-0.5 border-b border-slate-800 pb-2 last:border-b-0 last:pb-0">
                  <div class="text-sm font-medium text-slate-100 truncate">${col.name_pt || col.name_en || ""}</div>
                  <div class="text-[11px] text-slate-400 uppercase tracking-wide truncate">
                    ${line}${type ? " · " + type : ""}${year ? " · " + year : ""}
                  </div>
                  ${manufacturer ? `<div class="text-[11px] text-slate-500 truncate">${manufacturer}</div>` : ""}
                </li>`;
            })
            .join("");

          extrasHtml += `
            <section class="mt-6">
              <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide mb-2">
                Colecionáveis relacionados
              </h3>
              <ul class="space-y-2">${items}</ul>
            </section>
          `;
        }

        if (publications && publications.length) {
          const items = publications
            .map(pub => {
              const title = pub.title_pt || pub.title_en || "";
              const year = pub.year || "";
              const pubType = pub.pub_type || "";
              const publisher = pub.publisher || "";
              return `
                <li class="flex flex-col gap-0.5 border-b border-slate-800 pb-2 last:border-b-0 last:pb-0">
                  <div class="text-sm font-medium text-slate-100 truncate">${title}</div>
                  <div class="text-[11px] text-slate-400 uppercase tracking-wide truncate">
                    ${pubType}${year ? " · " + year : ""}
                  </div>
                  ${publisher ? `<div class="text-[11px] text-slate-500 truncate">${publisher}</div>` : ""}
                </li>
              `;
            })
            .join("");

          extrasHtml += `
            <section class="mt-6">
              <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide mb-2">
                Livros e revistas
              </h3>
              <ul class="space-y-2">${items}</ul>
            </section>
          `;
        }

        if (extrasHtml) {
          detailBody.innerHTML += extrasHtml;
        }
      } catch (e) {
        console.error("Erro extras personagem:", e);
      }
    }

    function showGlossaryDetail(g) {
      detailTitle.textContent = g.jp || "";
      let html = "";

      if (g.romaji) {
        html += `<div class="text-sm text-slate-200">${g.romaji}</div>`;
      }

      if (g.category) {
        html += `
          <div class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-800 text-[11px] text-slate-200 uppercase tracking-wide mt-1">
            ${g.category}
          </div>`;
      }

      if (g.pt) {
        html += `
          <section class="mt-4">
            <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Português</h3>
            <p class="text-sm mt-1 leading-relaxed">${g.pt}</p>
          </section>`;
      }

      if (g.en) {
        html += `
          <section class="mt-4">
            <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Inglês</h3>
            <p class="text-sm mt-1 leading-relaxed">${g.en}</p>
          </section>`;
      }

      if (g.explanation) {
        html += `
          <section class="mt-4">
            <h3 class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Explicação</h3>
            <p class="text-sm mt-1 leading-relaxed">${g.explanation}</p>
          </section>`;
      }

      detailBody.innerHTML = html;
      detailOverlay.classList.remove("hidden");
    }

    function closeDetail() {
      detailOverlay.classList.add("hidden");
    }

    async function loadCurrentTab() {
      const search = currentSearch.trim();
      if (search === "") {
        showEmptySearchMessage();
        return;
      }

      if (currentTab === "characters") {
        await fetchCharacters(search);
        renderCharactersList();
      } else if (currentTab === "glossary") {
        await fetchGlossary(search);
        renderGlossaryList();
      } else if (currentTab === "collectibles") {
        await fetchCollectibles(search);
        renderCollectiblesList();
      } else if (currentTab === "publications") {
        await fetchPublications(search);
        renderPublicationsList();
      }
    }

    function setActiveTab(tab) {
      const activeClasses = ["bg-slate-100", "text-slate-900"];
      const inactiveClasses = ["bg-slate-800", "text-slate-200"];

      [tabCharactersBtn, tabGlossaryBtn, tabCollectiblesBtn, tabPublicationsBtn].forEach(btn => {
        btn.classList.remove(...activeClasses);
        btn.classList.add(...inactiveClasses);
      });

      tab.classList.add(...activeClasses);
      tab.classList.remove(...inactiveClasses);
    }

    tabCharactersBtn.onclick = () => {
      currentTab = "characters";
      setActiveTab(tabCharactersBtn);
      loadCurrentTab();
    };

    tabGlossaryBtn.onclick = () => {
      currentTab = "glossary";
      setActiveTab(tabGlossaryBtn);
      loadCurrentTab();
    };

    tabCollectiblesBtn.onclick = () => {
      currentTab = "collectibles";
      setActiveTab(tabCollectiblesBtn);
      loadCurrentTab();
    };

    tabPublicationsBtn.onclick = () => {
      currentTab = "publications";
      setActiveTab(tabPublicationsBtn);
      loadCurrentTab();
    };

    searchInput.oninput = () => {
      currentSearch = searchInput.value;
      clearTimeout(searchInput._timer);
      searchInput._timer = setTimeout(() => loadCurrentTab(), 300);
    };

    detailClose.onclick = closeDetail;
    detailOverlay.onclick = e => {
      if (e.target === detailOverlay) closeDetail();
    };

    setActiveTab(tabCharactersBtn);
    showEmptySearchMessage();
  </script>
</body>
</html>