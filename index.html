// ✅ COLLECTIBLES (CORRIGIDO p/ seu schema atual)
const collectiblesTitle = document.getElementById("collectiblesTitle");
const collectiblesStatus = document.getElementById("collectiblesStatus");
const collectiblesList = document.getElementById("collectiblesList");
const inputCollectiblesSearch = document.getElementById("inputCollectiblesSearch");
const selectCollectiblesCategory = document.getElementById("selectCollectiblesCategory");
let collectiblesCache = [];

function colDisplayName(it) {
  return safeText(it.name_pt) || safeText(it.name_en) || safeText(it.name_jp) || "Colecionável";
}

async function openCollectibles() {
  collectiblesTitle.textContent = `${formatFranchise(state.franchise)} · Colecionáveis`;
  showView("collectibles");
  inputCollectiblesSearch.value = "";
  selectCollectiblesCategory.value = "";
  await loadCollectibles();

  // filtro principal por item_type (belt/figure/mecha/weapon etc)
  populateSelect(
    selectCollectiblesCategory,
    collectiblesCache.map(x => safeText(x.item_type)).filter(Boolean),
    "Todos"
  );

  renderCollectiblesList(filterCollectibles("", ""));
}

async function loadCollectibles() {
  collectiblesStatus.textContent = "Carregando...";
  collectiblesList.innerHTML = "";

  // ⚠️ NÃO inclui "url" aqui (se não existir, a query quebra)
  const { data, error } = await supabase
    .from("collectibles")
    .select("id,name_en,name_pt,name_jp,franchise,era,year,line,item_type,manufacturer,series_code,sku_code,image_url,jp_search,notes,rarity,status,created_at")
    .eq("franchise", state.franchise);

  if (error) {
    console.error("Collectibles load error:", error);
    collectiblesStatus.textContent = `Erro ao carregar colecionáveis: ${error.message}`;
    collectiblesCache = [];
    return;
  }

  const list = Array.isArray(data) ? data : [];
  list.sort((a, b) => colDisplayName(a).localeCompare(colDisplayName(b), "pt", { sensitivity: "base" }));

  collectiblesCache = list;
  collectiblesStatus.textContent = `${list.length} itens`;
}

function filterCollectibles(q, itemType) {
  const query = safeText(q).toLowerCase();
  const t = safeText(itemType).toLowerCase();

  return collectiblesCache.filter((it) => {
    if (t && safeText(it.item_type).toLowerCase() !== t) return false;
    if (!query) return true;

    return [
      it.name_pt, it.name_en, it.name_jp,
      it.line, it.item_type, it.manufacturer,
      it.series_code, it.sku_code,
      it.jp_search, it.notes, it.rarity, it.status,
      it.year, it.era
    ].some((v) => safeText(v).toLowerCase().includes(query));
  });
}

function renderCollectiblesList(list) {
  collectiblesList.innerHTML = "";
  if (!list.length) {
    collectiblesList.innerHTML = `<div class="muted" style="padding: 10px 2px;">Nenhum resultado.</div>`;
    return;
  }

  for (const it of list) {
    const el = document.createElement("div");
    el.className = "item";

    const img = safeText(it.image_url);
    const name = colDisplayName(it);
    const year = safeText(it.year);

    const subtitleParts = [];
    if (hasValue(it.line)) subtitleParts.push(safeText(it.line));
    if (hasValue(it.item_type)) subtitleParts.push(safeText(it.item_type));
    if (hasValue(it.manufacturer)) subtitleParts.push(safeText(it.manufacturer));

    el.innerHTML = `
      <div class="itemTop">
        <div class="thumb">
          ${hasValue(img) ? `<img src="${withCacheBuster(img)}" alt="${escapeHtml(name)}"
            onerror="this.style.display='none'; this.parentElement.textContent='';" />` : ``}
        </div>
        <div class="meta">
          <div class="nameLine">
            <div class="name">${escapeHtml(name)}</div>
            <div class="year">${escapeHtml(year)}</div>
          </div>
          <div class="muted" style="font-size:12px; line-height:1.2;">
            ${escapeHtml(subtitleParts.join(" · "))}
          </div>
        </div>
      </div>
      ${hasValue(it.notes) ? `<div class="desc">${escapeHtml(it.notes)}</div>` : ``}
    `;

    el.addEventListener("click", () => {
      modalTitle.textContent = name;
      setModalImage(img, name);
      setModalLink(""); // (no seu schema atual não tem url)

      const rows = [
        specRow("Nome (PT)", it.name_pt),
        specRow("Nome (EN)", it.name_en),
        specRow("Nome (JP)", it.name_jp),
        specRow("Linha", it.line),
        specRow("Tipo", it.item_type),
        specRow("Fabricante", it.manufacturer),
        specRow("Ano", it.year),
        specRow("Era", it.era),
        specRow("Series code", it.series_code),
        specRow("SKU", it.sku_code),
        specRow("Status", it.status),
        specRow("Raridade", it.rarity),
        specRow("JP search", it.jp_search),
        specRow("Notas", it.notes),
        specRow("Franquia", formatFranchise(it.franchise))
      ].filter(Boolean).join("");

      modalBody.innerHTML = renderSpecCard(rows);
      openModal();
    });

    collectiblesList.appendChild(el);
  }
}

inputCollectiblesSearch.addEventListener("input", () =>
  renderCollectiblesList(filterCollectibles(inputCollectiblesSearch.value, selectCollectiblesCategory.value))
);
selectCollectiblesCategory.addEventListener("change", () =>
  renderCollectiblesList(filterCollectibles(inputCollectiblesSearch.value, selectCollectiblesCategory.value))
);
