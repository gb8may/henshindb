<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Henshin DB</title>

<style>
:root {
  --bg:#0b0f14;
  --panel:#121821;
  --border:rgba(255,255,255,.12);
  --text:#e6eaf0;
  --muted:#9aa4b2;
  --danger:#ff6b6b;
}

* { box-sizing:border-box; }
body {
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background:var(--bg);
  color:var(--text);
}

main {
  max-width:420px;
  margin:0 auto;
  padding:16px;
}

h1,h2 { margin:0 0 12px 0; }

.notice {
  display:none;
  margin:12px 0;
  padding:10px 12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.04);
  border-radius:12px;
  font-size:12px;
  color:var(--muted);
}
.notice.danger {
  border-color:rgba(255,107,107,.35);
  color:var(--danger);
}

input {
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
}

.grid {
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}

.btn {
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
  text-align:left;
  font-size:14px;
  cursor:pointer;
  user-select:none;
}

.btn small {
  font-size:11px;
  color:var(--muted);
}

.list {
  list-style:none;
  padding:0;
  margin:12px 0;
}

.list li {
  padding:10px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
}

.hidden { display:none; }

.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.modalCard {
  background:var(--panel);
  border-radius:16px;
  padding:16px;
  max-width:92%;
  max-height:90%;
  overflow:auto;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}

.modalCard img {
  width:100%;
  border-radius:12px;
  margin-bottom:12px;
  display:block;
}

footer {
  text-align:center;
  font-size:11px;
  color:var(--muted);
  padding:20px 0 10px;
}
</style>
</head>

<body>
<main>

<div id="notice" class="notice"></div>

<section id="view-home">
  <h1>Henshin DB</h1>
  <p style="color:var(--muted); margin-top:0">Escolha um tema</p>

  <div class="grid">
    <button class="btn js-franchise" data-franchise="kamen rider">
      Kamen Rider<br><small>Riders</small>
    </button>
    <button class="btn js-franchise" data-franchise="super sentai">
      Super Sentai<br><small>Equipes</small>
    </button>
    <button class="btn js-franchise" data-franchise="metal hero">
      Metal Hero<br><small>Clássicos</small>
    </button>
  </div>
</section>

<section id="view-hub" class="hidden">
  <h2 id="hub-title"></h2>

  <div class="grid">
    <button class="btn js-nav" data-target="characters">Personagens</button>
    <button class="btn js-nav" data-target="glossary">Glossário</button>
    <button class="btn js-nav" data-target="publications">Publicações</button>
    <button class="btn js-nav" data-target="collectibles">Colecionáveis</button>
  </div>

  <br>
  <button class="btn js-home">← Voltar</button>
</section>

<section id="view-characters" class="hidden">
  <h2>Personagens</h2>
  <input id="search" placeholder="Buscar personagem...">
  <ul id="char-list" class="list"></ul>
  <button class="btn js-back-hub">← Voltar</button>
</section>

<section id="view-glossary" class="hidden">
  <h2>Glossário</h2>
  <ul id="glossary-list" class="list"></ul>
  <button class="btn js-back-hub">← Voltar</button>
</section>

<section id="view-publications" class="hidden">
  <h2>Publicações</h2>
  <p style="color:var(--muted)">Em breve</p>
  <button class="btn js-back-hub">← Voltar</button>
</section>

<section id="view-collectibles" class="hidden">
  <h2>Colecionáveis</h2>
  <p style="color:var(--muted)">Em breve</p>
  <button class="btn js-back-hub">← Voltar</button>
</section>

</main>

<footer>
v0.1 · Henshin DB · Author: Mayara Gouveia
</footer>

<div id="modal" class="modal hidden">
  <div class="modalCard" id="modal-content"></div>
</div>

<script>
const SUPABASE_URL = "https://grvmisyiyxzlqfqgponm.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdydm1pc3lpeXh6bHFmcWdwb25tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTgwNTgsImV4cCI6MjA4MDg3NDA1OH0.VPzEEvayTYxVZ7D56h7pWFCVDykciO7OCmGrmD1J0XE";

let franchise = "";

function setNotice(msg, type="info") {
  const el = document.getElementById("notice");
  if (!msg) { el.style.display="none"; el.className="notice"; el.textContent=""; return; }
  el.style.display="block";
  el.textContent = msg;
  el.className = type === "danger" ? "notice danger" : "notice";
}

function show(id) {
  document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function goHome() { setNotice(""); show("view-home"); }
function backToHub() { setNotice(""); show("view-hub"); }

function openFranchise(f) {
  franchise = f;
  document.getElementById("hub-title").innerText = f.toUpperCase();
  setNotice("");
  show("view-hub");
}

function openCharacters() {
  setNotice("Digite algo na busca para listar resultados.", "info");
  document.getElementById("search").value = "";
  document.getElementById("char-list").innerHTML = "";
  show("view-characters");
}

function openGlossary() {
  loadGlossary();
  show("view-glossary");
}

function openPublications(){ show("view-publications"); }
function openCollectibles(){ show("view-collectibles"); }

function supabaseHeaders() {
  return {
    apikey: SUPABASE_ANON_KEY,
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`
  };
}

async function safeJson(res) {
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { raw: text }; }
}

async function loadCharacters() {
  try {
    const q = document.getElementById("search").value.trim();
    const ul = document.getElementById("char-list");
    ul.innerHTML = "";

    if (!q) return;

    if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("COLE_SUA_ANON_KEY")) {
      setNotice("Cole sua SUPABASE_ANON_KEY no index.html (senão nada vai carregar).", "danger");
      return;
    }

    const franchiseValue = encodeURIComponent(franchise);
    const qEscaped = q.replace(/[%]/g, "\\%").replace(/_/g, "\\_");
    const qEncoded = encodeURIComponent(qEscaped);

    const url =
      `${SUPABASE_URL}/rest/v1/characters` +
      `?franchise=eq.${franchiseValue}` +
      `&or=(name_pt.ilike.*${qEncoded}*,name_en.ilike.*${qEncoded}*)` +
      `&order=name_pt.asc`;

    const res = await fetch(url, { headers: supabaseHeaders() });
    if (!res.ok) {
      const err = await safeJson(res);
      setNotice(`Erro ao buscar personagens: HTTP ${res.status} ${JSON.stringify(err)}`, "danger");
      return;
    }

    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      setNotice("Nenhum resultado.", "info");
      return;
    }

    setNotice("");

    data.forEach(c => {
      const li = document.createElement("li");
      li.textContent = c.name_pt || c.name_en || "(sem nome)";
      li.addEventListener("click", () => openCharacter(c));
      ul.appendChild(li);
    });
  } catch (e) {
    setNotice(`Erro inesperado ao buscar: ${e?.message || e}`, "danger");
    console.error(e);
  }
}

function openCharacter(c){
  const m = document.getElementById("modal-content");

  const img = c.image_url ? `<img src="${c.image_url}" alt="">` : "";
  const title = (c.name_pt || c.name_en || "").trim();
  const desc = (c.description || "").trim();

  const civil = (c.civil_name || "").trim();
  const actor = (c.actor_name || "").trim();

  m.innerHTML = `
    ${img}
    <h3 style="margin:0 0 8px 0">${title}</h3>
    ${civil ? `<p style="margin:0 0 6px 0"><b>Nome civil:</b> ${civil}</p>` : ""}
    ${actor ? `<p style="margin:0 0 6px 0"><b>Ator:</b> ${actor}</p>` : ""}
    ${desc ? `<p style="margin:10px 0 0 0; color:var(--muted)">${desc}</p>` : ""}
  `;

  document.getElementById("modal").classList.remove("hidden");
}

function closeModal(){
  document.getElementById("modal").classList.add("hidden");
}

async function loadGlossary(){
  try {
    if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("COLE_SUA_ANON_KEY")) {
      setNotice("Cole sua SUPABASE_ANON_KEY no index.html para carregar o glossário.", "danger");
      return;
    }

    const res = await fetch(`${SUPABASE_URL}/rest/v1/glossary?order=pt.asc`, { headers: supabaseHeaders() });
    if (!res.ok) {
      const err = await safeJson(res);
      setNotice(`Erro ao carregar glossário: HTTP ${res.status} ${JSON.stringify(err)}`, "danger");
      return;
    }

    const data = await res.json();
    const ul = document.getElementById("glossary-list");
    ul.innerHTML = "";

    data.forEach(t=>{
      const li = document.createElement("li");
      li.innerHTML = `<b>${t.pt || t.en || t.romaji || ""}</b><br><small style="color:var(--muted)">${t.explanation || ""}</small>`;
      ul.appendChild(li);
    });

    setNotice("");
  } catch (e) {
    setNotice(`Erro inesperado no glossário: ${e?.message || e}`, "danger");
    console.error(e);
  }
}

/* ==========
   BINDINGS (sem onclick inline)
========== */
document.addEventListener("DOMContentLoaded", () => {
  // franquias (home)
  document.querySelectorAll(".js-franchise").forEach(btn => {
    btn.addEventListener("click", () => openFranchise(btn.dataset.franchise));
  });

  // navegação do hub
  document.querySelectorAll(".js-nav").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      if (target === "characters") return openCharacters();
      if (target === "glossary") return openGlossary();
      if (target === "publications") return openPublications();
      if (target === "collectibles") return openCollectibles();
    });
  });

  // voltar
  document.querySelectorAll(".js-home").forEach(btn => btn.addEventListener("click", goHome));
  document.querySelectorAll(".js-back-hub").forEach(btn => btn.addEventListener("click", backToHub));

  // busca
  document.getElementById("search").addEventListener("input", loadCharacters);

  // modal close
  const modal = document.getElementById("modal");
  modal.addEventListener("click", closeModal);
  document.getElementById("modal-content").addEventListener("click", (e) => e.stopPropagation());

  // start
  goHome();
});
</script>

</body>
</html>
